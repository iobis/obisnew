<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
<script src="/assets/script.js"></script>

<section class="section-dense pb-0">
  <div class="container">
      
    <p>Dataset</p>
    <h1>{{ dataset.title }}</h1>
    <p>
      {% for node in dataset.nodes %}
      <a href="/node/{{ node.id }}"><span class="badge tag">{{ node.name }}</span></a>
      {% endfor %}
    </p>
    <div class="mt-5 mb-3">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="quality-tab" data-bs-toggle="tab" data-bs-target="#quality" type="button" role="tab" aria-controls="profile" aria-selected="false">Data quality</button>
        </li>
      </ul>
    </div>

  </div>
</section>

<div class="tab-content" id="myTabContent">
  <div class="tab-pane show active" id="home" role="tabpanel" aria-labelledby="home-tab">

    <div class="container">
      <p>{{ dataset.abstract }}</p>

      {% if dataset.citation %}
      <p>Citation: <i>{{ dataset.citation }}</i></p>
      {% endif %}
  
      <p>URL: <a href="{{ dataset.url }}" target="_blank">{{ dataset.url }}</a></p>
  
      <div class="row">
        {% for contact in dataset.contacts %}
          <div class="col-md-4">
          <p><b>{{ contact.givenname }} {{ contact.surname }}</b>
          <br/>{{ contact.organization }}</p>
          </div>
        {% endfor %}
      </div>
  
      <div class="row gx-5">
        <div class="col">
          {% with filter="datasetid=" + dataset.id|string %}
          {% include "components/map.html" %}
          {% endwith %}
        </div>
        <div class="col">
          <div id="sunburst" style="height: 600px;"></div>
        </div>
      </div>

      <div class="row gx-5">
        <div class="col">
          <div id="timeplot"></div>
        </div>
      </div>
  
    <section class="section-dense section-dark">
      <div class="container">
        <div class="row gx-5">
          <div class="col">
            <h2>Taxa</h2>
            <div id="taxa"></div>
          </div>
        </div>
      </div>
  
    </section>
    
  </div>

  <div class="tab-pane" id="quality" role="tabpanel" aria-labelledby="quality-tab">

    <div class="container">
      <h3>Missing and invalid fields</h3>

      {% if quality_statistics.fields %}
      <table class="table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Missing</th>
            <th>Invalid</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for field, stats in quality_statistics.fields.items() %}
          <tr>
            <td>{{ field }}</td>
            <td>{{ "{:0,.0f}".format(stats.missing) if stats.missing else "" }}</td>
            <td>{{ "{:0,.0f}".format(stats.invalid) if stats.invalid else "" }}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 0.5em;">
                <div class="progress" style="width: 200px;">
                  <div class="progress-bar" role="progressbar" style="width: {{ stats.total / dataset.statistics.Occurrence * 100 }}%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span>{{ (stats.total / dataset.statistics.Occurrence * 100)|round(1) }}%</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No missing or invalid fields.</p>
      {% endif %}
  
      <h3>Quality flags</h3>
  
      {% if quality_statistics.flags %}
      <table class="table">
        <thead>
          <tr>
            <th>Flag</th>
            <th>Records</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for flag, records in quality_statistics.flags.items() %}
          <tr>
            <td>{{ flag }}</td>
            <td>{{ "{:0,.0f}".format(records) if records else "" }}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 0.5em;">
                <div class="progress" style="width: 200px;">
                  <div class="progress-bar" role="progressbar" style="width: {{ records / dataset.statistics.Occurrence * 100 }}%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span>{{ (records / dataset.statistics.Occurrence * 100)|round(1) }}%</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No quality flags.</p>
      {% endif %}
  
    </div>

  </div>
</div>

<script>
fetchDatasetTaxonomy("{{ dataset.id }}").then(convertToSunburst).then((data) => {
    var layout = {
        margin: {l: 0, r: 0, b: 30, t: 30},
        sunburstcolorway: ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"]
        // sunburstcolorway: ["#54bebe", "#76c8c8", "#98d1d1", "#badbdb", "#dedad2", "#e4bcad", "#df979e", "#d7658b", "#c80064"]
    };
    Plotly.newPlot("sunburst", data, layout);
});

let currentSkip = 0;
const pageSize = 10;

async function fetchTaxa(skip = 0) {
    currentSkip = skip;
    
    const url = `https://api.obis.org/checklist?datasetid={{ dataset.id }}&size=${pageSize}&skip=${skip}`;

    const resultsDiv = document.getElementById("taxa");
    resultsDiv.innerHTML = "<p>Searching...</p>";

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data && data.results && data.results.length > 0) {
            renderTable("taxa", data.results, data.total, skip, pageSize, renderTaxonItem, fetchTaxa);
        } else {
            resultsDiv.innerHTML = "<p>No results found.</p>";
        }
    } catch (error) {
        resultsDiv.innerHTML = "<p>Error fetching results.</p>";
        console.error(error);
    }
}

fetchTaxa();

renderTimeplot("timeplot", { datasetid: "{{ dataset.id }}" })
</script>
