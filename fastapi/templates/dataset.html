<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

<p>Dataset</p>

<h1>{{ dataset.title }}</h1>

<p>
  {% for node in dataset.nodes %}
  <span class="badge tag">{{ node.name }}</span>
  {% endfor %}
</p>

<div class="mt-4 mb-3">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="quality-tab" data-bs-toggle="tab" data-bs-target="#quality" type="button" role="tab" aria-controls="profile" aria-selected="false">Data quality</button>
    </li>
  </ul>
</div>

<div class="tab-content" id="myTabContent">
  <div class="tab-pane show active" id="home" role="tabpanel" aria-labelledby="home-tab">
    <p>{{ dataset.abstract }}</p>

    {% if dataset.citation %}
    <p>Citation: <i>{{ dataset.citation }}</i></p>
    {% endif %}

    <p>URL: <a href="{{ dataset.url }}" target="_blank">{{ dataset.url }}</a></p>

    <div class="row">
      {% for contact in dataset.contacts %}
        <div class="col-md-4">
        <p><b>{{ contact.givenname }} {{ contact.surname }}</b>
        <br/>{{ contact.organization }}</p>
        </div>
      {% endfor %}
    </div>

    <div id="sunburst" style="height: 700px;"></div>
  </div>

  <div class="tab-pane" id="quality" role="tabpanel" aria-labelledby="quality-tab">

    <h3>Missing and invalid fields</h3>

    <table class="table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Missing</th>
          <th>Invalid</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for field, stats in quality_statistics.fields.items() %}
        <tr>
          <td>{{ field }}</td>
          <td>{{ stats.missing }}</td>
          <td>{{ stats.invalid }}</td>
          <td>
            <div class="progress" style="width: 200px;">
              <div class="progress-bar" role="progressbar" style="width: {{ stats.total / dataset.statistics.Occurrence * 100 }}%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>Quality flags</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Flag</th>
          <th>Records</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for flag, records in quality_statistics.flags.items() %}
        <tr>
          <td>{{ flag }}</td>
          <td>{{ records }}</td>
          <td>
            <div class="progress" style="width: 200px;">
              <div class="progress-bar" role="progressbar" style="width: {{ records / dataset.statistics.Occurrence * 100 }}%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>

<script>

async function fetchAndConvertToSunburst(datasetid) {
  const url = `https://api.obis.org/statistics/taxonomy?datasetid=${datasetid}`;

  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error ${response.status}`);
    }
    const taxonomyTree = await response.json();
    const { labels, parents, values } = flattenForSunburst(taxonomyTree);
    const plotlyData = [{
      type: "sunburst",
      labels,
      parents,
      values,
      leaf: { opacity: 0.4 },
      marker: {
        line: { width: 2 },
        colors: values,
        colorscale: "PuRd"
      }
    }];
    return plotlyData;
  } catch (error) {
    console.error("Failed to fetch or convert taxonomy data:", error.message);
  }
}

function flattenForSunburst(node, parent = "") {
  const labels = [];
  const parents = [];
  const values = [];

  function recurse(currentNode, currentParent) {
    let { name, value, children } = currentNode;

    if (typeof value !== "number" && Array.isArray(children)) {
      value = children.reduce((sum, child) => {
        return sum + (typeof child.value === "number" ? child.value : 0);
      }, 0);
    }

    labels.push(name);
    parents.push(currentParent);
    values.push(value);

    if (children && children.length > 0) {
      for (const child of children) {
        recurse(child, name);
      }
    }
  }

  recurse(node, parent);
  return { labels, parents, values };
}

fetchAndConvertToSunburst("{{ dataset.id }}").then((data) => {
  var layout = {
    margin: {l: 0, r: 0, b: 30, t: 30},
  };
  Plotly.newPlot("sunburst", data, layout);
});

</script>